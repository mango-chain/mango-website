<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>마이 대시보드 - Mango Chain</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-color: #111111; --card-color: #1f1f1f; --point-color: #FFC107; --text-color: #ffffff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Pretendard', sans-serif; padding-top: 80px; }
        
        /* 공통 스타일 */
        .navbar { background: rgba(17, 17, 17, 0.95); border-bottom: 1px solid #333; }
        .btn-logout { border: 1px solid #444; color: #fff; border-radius: 20px; padding: 5px 15px; font-size: 0.8rem; }
        .section-card { background: var(--card-color); border: 1px solid #333; border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .section-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; color: var(--point-color); display: flex; align-items: center; gap: 10px; }
        
        /* 폼 스타일 */
        .form-label { font-size: 0.9rem; color: #aaa; margin-top: 10px; }
        .form-control, .form-select { background: #111; border: 1px solid #444; color: #fff; }
        .form-control:focus, .form-select:focus { background: #111; color: #fff; border-color: var(--point-color); box-shadow: none; }
        
        /* 체크박스 버튼 그룹 */
        .btn-check-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-check + .btn-outline-warning { border-color: #444; color: #aaa; }
        .btn-check:checked + .btn-outline-warning { background-color: var(--point-color); color: #000; border-color: var(--point-color); }

        /* 상태 디스플레이 */
        .status-box { background: #111; padding: 15px; border-radius: 10px; border: 1px solid #333; margin-top: 20px; font-size: 0.9rem; color: #888; }
        .status-value { color: #fff; font-weight: bold; margin-left: 5px; }

        /* 포지션 창 */
        .position-window {
            background: #000; border: 1px solid var(--point-color); border-radius: 10px; 
            padding: 15px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; color: #0f0;
        }

        /* 봇 토글 스위치 */
        .bot-switch-wrapper { display: flex; align-items: center; justify-content: space-between; background: #333; padding: 15px 20px; border-radius: 50px; margin-bottom: 20px; }
        .form-check-input { width: 3em; height: 1.5em; cursor: pointer; }
        .form-check-input:checked { background-color: #2ecc71; border-color: #2ecc71; }
        
        /* 로딩 오버레이 */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:none; align-items:center; justify-content:center; flex-direction: column;}
    </style>
</head>
<body>
    <div id="overlay">
        <div class="spinner-border text-warning" role="status"></div>
        <div class="mt-3 text-white">데이터 처리 중...</div>
    </div>

    <nav class="navbar navbar-expand fixed-top navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-robot text-warning"></i> MANGO BOT</a>
            <div class="ms-auto d-flex align-items-center gap-3">
                <span id="welcome-msg" class="text-white small d-none d-md-block"></span>
                <button onclick="logout()" class="btn-logout">로그아웃</button>
            </div>
        </div>
    </nav>

    <div class="container" style="max-width: 800px;">
        
        <div class="bot-switch-wrapper">
            <div class="fw-bold text-white fs-5"><i class="bi bi-power"></i> 봇 전원 스위치</div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="botToggle" onchange="toggleBot()">
                <label class="form-check-label text-white fw-bold ms-2" for="botToggle" id="botLabel">OFF</label>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <div class="section-card">
                    <div class="section-title"><i class="bi bi-sliders"></i> 매매 환경 설정</div>
                    
                    <label class="form-label">거래소 선택</label>
                    <select class="form-select" id="exchange-select">
                        <option value="Binance">Binance (바이낸스)</option>
                        <option value="OKX">OKX</option>
                        <option value="Bybit">Bybit (바이비트)</option>
                        <option value="Bitget">Bitget (비트겟)</option>
                        <option value="BingX">BingX (빙엑스)</option>
                    </select>

                    <label class="form-label">API Key</label>
                    <input type="text" class="form-control" id="api-key" placeholder="거래소에서 발급받은 Access Key">

                    <label class="form-label">Secret Key</label>
                    <input type="password" class="form-control" id="secret-key" placeholder="거래소에서 발급받은 Secret Key">

                    <label class="form-label d-flex justify-content-between">
                        <span>레버리지 설정</span>
                        <span class="text-warning fw-bold" id="leverage-val">10x</span>
                    </label>
                    <input type="range" class="form-range" min="1" max="20" step="1" id="leverage-range" oninput="updateLevDisp(this.value)">

                    <label class="form-label">진입 종목 (다중 선택)</label>
                    <div class="btn-check-group">
                        <input type="checkbox" class="btn-check symbol-chk" id="sym-btc" value="BTC">
                        <label class="btn btn-outline-warning btn-sm rounded-pill" for="sym-btc">BTC</label>

                        <input type="checkbox" class="btn-check symbol-chk" id="sym-eth" value="ETH">
                        <label class="btn btn-outline-warning btn-sm rounded-pill" for="sym-eth">ETH</label>

                        <input type="checkbox" class="btn-check symbol-chk" id="sym-xrp" value="XRP">
                        <label class="btn btn-outline-warning btn-sm rounded-pill" for="sym-xrp">XRP</label>

                        <input type="checkbox" class="btn-check symbol-chk" id="sym-sol" value="SOL">
                        <label class="btn btn-outline-warning btn-sm rounded-pill" for="sym-sol">SOL</label>
                    </div>

                    <label class="form-label">1회 진입 시드 (USDT)</label>
                    <input type="number" class="form-control" id="entry-seed" placeholder="예: 100">
                    <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle"></i> 총 자산의 10% 이하 설정을 권장합니다.</div>

                    <button class="btn btn-warning w-100 mt-4 fw-bold" onclick="saveSettings()">
                        <i class="bi bi-save"></i> 설정 저장하기
                    </button>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="section-card">
                    <div class="section-title"><i class="bi bi-window-stack"></i> 실시간 포지션 현황</div>
                    <div class="position-window" id="position-display">
                        데이터를 불러오는 중...<br>
                        [대기중]
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-title"><i class="bi bi-clipboard-data"></i> 현재 적용된 설정</div>
                    <div class="status-box">
                        <div class="mb-2">거래소: <span class="status-value" id="disp-exchange">-</span></div>
                        <div class="mb-2">레버리지: <span class="status-value" id="disp-leverage">-</span></div>
                        <div class="mb-2">종목: <span class="status-value" id="disp-symbols">-</span></div>
                        <div class="mb-2">진입시드: <span class="status-value" id="disp-seed">-</span></div>
                        
                        <div class="mt-3 pt-2 border-top border-secondary">
                            내 선물 계좌 잔고: <span class="text-warning fw-bold fs-5" id="my-balance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </span>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzGOdzeCFy5iMye18107R_3Tbteq-5RJDFKKb9gH0nRg26fzyGUe0KeX-tKcka4PaQ4PQ/exec';
        
        const sheetId = '1UpncS47X9zbM0FUNwOvr7jCIOsfkUugdmxgkDy1Ntlw';
        const gid = '830244407'; // members GID
        const userCode = sessionStorage.getItem("mango_user_code");

        // 로그인 체크
        if (!userCode) {
            alert("로그인이 필요합니다.");
            location.href = "/bot";
        } else {
            document.getElementById('welcome-msg').innerText = sessionStorage.getItem("mango_user_name") + "님";
            loadData(); // 데이터 불러오기
        }

        // [읽기] 구글 시트에서 설정값 가져오기
        function loadData() {
            const timestamp = new Date().getTime();
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&t=${timestamp}`;

            Papa.parse(csvUrl, {
                download: true,
                header: false,
                complete: function(results) {
                    const data = results.data;
                    let myRow = null;

                    for(let i=0; i<data.length; i++) {
                        if(data[i][0] && data[i][0].toString().trim().toUpperCase() === userCode.toUpperCase()) {
                            myRow = data[i];
                            break;
                        }
                    }

                    if(myRow) {
                        // 1. 봇 상태
                        const botStat = (myRow[4] || "OFF").toUpperCase();
                        const toggle = document.getElementById('botToggle');
                        toggle.checked = (botStat === "ON");
                        updateBotLabel(toggle.checked);

                        // 2. 입력폼 채우기
                        document.getElementById('exchange-select').value = myRow[7] || "Binance";
                        document.getElementById('api-key').value = myRow[8] || "";
                        document.getElementById('secret-key').value = myRow[9] || ""; 
                        
                        const lev = myRow[10] || 10;
                        document.getElementById('leverage-range').value = lev;
                        updateLevDisp(lev);

                        const symbols = myRow[11] || "";
                        document.querySelectorAll('.symbol-chk').forEach(chk => {
                            chk.checked = symbols.includes(chk.value);
                        });

                        document.getElementById('entry-seed').value = myRow[12] || "";

                        // 3. 우측 현황판
                        document.getElementById('disp-exchange').innerText = myRow[7] || "-";
                        document.getElementById('disp-leverage').innerText = lev + "x";
                        document.getElementById('disp-symbols').innerText = symbols || "-";
                        document.getElementById('disp-seed').innerText = (myRow[12] || "0") + " USDT";
                        
                        // [수정됨] 기존 수익금 표시는 주석 처리하고 실제 잔액 조회를 실행합니다
                        // document.getElementById('disp-profit').innerText = "₩" + (myRow[5] || "0");
                        
                        // [신규] 실제 잔액 가져오기 (app.py API 호출)
                        fetchRealBalance();
                        
                        // 4. 포지션 창
                        document.getElementById('position-display').innerText = myRow[13] || "현재 진입한 포지션이 없습니다.";
                    }
                }
            });
        }

        // [신규] 서버(app.py)에 요청해서 실제 잔액 가져오기
        function fetchRealBalance() {
            fetch('/api/balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: userCode })
            })
            .then(response => response.json())
            .then(data => {
                const balanceEl = document.getElementById('my-balance');
                if (data.status === 'success') {
                    // 소수점 2자리까지 표시 (예: 1,234.56 USDT)
                    const balance = parseFloat(data.balance).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    balanceEl.innerText = balance + " USDT";
                } else {
                    balanceEl.innerText = "연동 실패";
                    balanceEl.style.fontSize = "0.9rem";
                    balanceEl.style.color = "#e74c3c";
                    console.log("잔액 조회 실패:", data.message);
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('my-balance').innerText = "오류";
            });
        }

        // [쓰기] 설정 저장하기
        function saveSettings() {
            const exchange = document.getElementById('exchange-select').value;
            const apiKey = document.getElementById('api-key').value;
            const secretKey = document.getElementById('secret-key').value;
            const leverage = document.getElementById('leverage-range').value;
            const seed = document.getElementById('entry-seed').value;
            
            let selectedSyms = [];
            document.querySelectorAll('.symbol-chk:checked').forEach(chk => {
                selectedSyms.push(chk.value);
            });
            
            if(!apiKey || !secretKey || !seed) {
                alert("API 키, 시크릿 키, 시드 금액은 필수입니다.");
                return;
            }

            if(selectedSyms.length === 0) {
                alert("최소 1개 이상의 종목을 선택해주세요.");
                return;
            }

            showOverlay(true);

            const payload = {
                type: 'SAVE_SETTINGS',
                code: userCode,
                exchange: exchange,
                apiKey: apiKey,
                secretKey: secretKey,
                leverage: leverage,
                symbols: selectedSyms.join(','),
                seed: seed
            };

            fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                setTimeout(() => {
                    showOverlay(false);
                    alert("설정이 안전하게 저장되었습니다!");
                    loadData(); 
                }, 1500); 
            }).catch(err => {
                showOverlay(false);
                alert("저장 실패. 관리자에게 문의하세요.");
            });
        }

        // [쓰기] 봇 ON/OFF 토글
        function toggleBot() {
            const toggle = document.getElementById('botToggle');
            const status = toggle.checked ? "ON" : "OFF";
            updateBotLabel(toggle.checked);

            showOverlay(true);

            const payload = {
                type: 'TOGGLE_BOT',
                code: userCode,
                status: status
            };

            fetch(scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                setTimeout(() => {
                    showOverlay(false);
                }, 1000);
            });
        }

        function updateLevDisp(val) {
            document.getElementById('leverage-val').innerText = val + "x";
        }

        function updateBotLabel(isOn) {
            const label = document.getElementById('botLabel');
            label.innerText = isOn ? "가동중 (ON)" : "정지 (OFF)";
            label.style.color = isOn ? "#2ecc71" : "#e74c3c";
        }

        function showOverlay(show) {
            document.getElementById('overlay').style.display = show ? 'flex' : 'none';
        }

        function logout() {
            sessionStorage.clear();
            location.href = "/";
        }
    </script>
</body>
</html>