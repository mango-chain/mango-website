<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 성과 - Mango Chain</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-color: #111111; --card-color: #1a1a1a; --point-color: #FFC107; --text-color: #ffffff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Pretendard', sans-serif; }
        
        .navbar { background: rgba(17, 17, 17, 0.95); border-bottom: 1px solid #333; z-index: 1050; height: 56px; }
        .nav-link { color: #ccc !important; margin: 0 10px; }
        .nav-link.active, .nav-link:hover { color: var(--point-color) !important; }
        .btn-main { background-color: var(--point-color); color: #000; font-weight: 700; border-radius: 50px; padding: 8px 25px; }

        .page-header { padding-top: 100px; text-align: center; margin-bottom: 30px; }
        .page-title { color: var(--point-color); font-weight: 800; font-size: 2rem; letter-spacing: -1px; }

        /* ▼▼▼ [신규] 드롭다운 & 수익금 박스 컨테이너 ▼▼▼ */
        .dashboard-controls {
            max-width: fit-content;
            margin: 0 auto 20px auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* 오른쪽 정렬 */
        }

        /* 드롭다운 스타일 */
        #month-filter {
            background-color: #1f1f1f;
            color: var(--point-color);
            border: 2px solid var(--point-color);
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-family: 'Pretendard', sans-serif;
            cursor: pointer;
            outline: none;
            margin-bottom: 10px; /* 수익금 박스와의 간격 */
            font-size: 1rem;
            min-width: 150px;
        }
        #month-filter option { background-color: #111; color: #fff; }

        /* 수익금 박스 */
        .profit-header-box {
            background: #1f1f1f;
            border: 2px solid var(--point-color);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.15);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            width: 100%; /* 부모에 맞춤 */
        }
        @media (min-width: 768px) {
            .profit-header-box { flex-direction: row; gap: 30px; }
        }
        .profit-desc { color: #ddd; font-size: 1.1rem; font-weight: 500; margin: 0; }
        .profit-amount { color: #fff; font-size: 2rem; font-weight: 800; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); margin: 0; }

        /* 테이블 컨테이너 */
        .table-container { 
            background: #111; 
            border: 2px solid var(--point-color); 
            border-radius: 15px; 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.1);
            overflow-x: auto; 
            max-height: 80vh; 
            position: relative;
            width: fit-content; 
            margin: 0 auto;     
        }

        .custom-table { 
            width: auto; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.85rem; 
            table-layout: fixed; 
            margin: 0;
        }
        
        .custom-table th, .custom-table td { 
            padding: 10px 4px; 
            text-align: center; 
            border-bottom: 1px solid #333; 
            border-right: 1px solid #222;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* Sticky Header */
        .sticky-top-1 {
            position: sticky; top: 0; 
            background-color: var(--point-color) !important; color: #000 !important;
            font-weight: 800; z-index: 1020; height: 45px; border-bottom: 1px solid #000;
        }
        .sticky-top-2 {
            position: sticky; top: 45px; 
            background-color: #2c2c2c !important; color: #fff !important;
            font-weight: bold; z-index: 1020; height: 45px;
            border-bottom: 2px solid var(--point-color); box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .data-row { background-color: #1a1a1a; color: #bbb; }
        .data-row:hover { background-color: #2a2a2a; }
        .sub-summary-row { background-color: #333 !important; color: #ffeb3b !important; font-weight: bold; }

        .text-white { color: #ffffff !important; font-weight: bold; }
        .text-gray { color: #888888 !important; font-weight: 500; }
        .text-up { color: #2ecc71 !important; font-weight: bold; }
        .text-down { color: #e74c3c !important; font-weight: bold; }

        #loading { text-align: center; padding: 50px; color: #666; position: absolute; width: 100%; top: 50px;}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-lightning-charge-fill text-warning"></i> MANGO CHAIN</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="/">홈</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pricing">상품설명</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/performance">실시간성과</a></li>
                    <li class="nav-item ms-3"><a class="btn btn-main" href="/bot">자동매매봇 입장</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="container page-header">
        <div class="d-inline-block text-center mb-3">
            <img src="{{ url_for('static', filename='favicon.png') }}" alt="Mango" style="width: 50px; margin-bottom: 10px;">
            <div class="page-title">MANGO SIGNAL RECORD</div>
            <div class="mt-2">
                <span class="badge bg-dark border border-warning text-warning">
                    <i class="bi bi-stars"></i> 30분마다 자동 업데이트 중
                </span>
            </div>
        </div>
    </section>

    <section class="container-fluid pb-5"> 
        
        <div class="dashboard-controls">
            <select id="month-filter" onchange="renderFilteredTable()">
                <option value="ALL">전체기록</option>
                </select>

            <div class="profit-header-box">
                <p class="profit-desc">매매당 비중 10% 사용 전체시드 1000만원기준 총수익금</p>
                <h2 class="profit-amount" id="total-profit-display">Loading...</h2>
            </div>
        </div>

        <div class="table-container">
            <table class="custom-table" id="trade-table">
                <colgroup>
                    <col style="width: 100px"> <col style="width: 60px">  <col style="width: 90px">  <col style="width: 70px">  <col style="width: 80px">  <col style="width: 80px">  <col style="width: 100px"> <col style="width: 100px"> <col style="width: 120px"> </colgroup>
                
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
            
            <div id="loading">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 small">데이터 불러오는 중...</p>
            </div>
        </div>
    </section>

    <footer style="border-top: 1px solid #333; padding: 50px 0; margin-top: 50px; color: #666; text-align: center;">
        <div class="container">
            <p class="small">&copy; 2025 Mango Chain. All rights reserved.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const sheetId = '1UpncS47X9zbM0FUNwOvr7jCIOsfkUugdmxgkDy1Ntlw';
        const gid = '262148501';

        // 데이터를 전역 변수에 저장해서 필터링할 때마다 다시 다운로드 안 하게 함
        let globalData = [];
        let summaryIndex = -1;
        let headerIndex = -1;

        function loadSheetData() {
            const timestamp = new Date().getTime(); 
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&t=${timestamp}`;

            const loading = document.getElementById('loading');
            
            Papa.parse(csvUrl, {
                download: true,
                header: false,
                complete: function(results) {
                    globalData = results.data;
                    loading.style.display = 'none';

                    if(globalData.length < 5) return;

                    // 1. 헤더/통계 줄 위치 찾기
                    for(let i=0; i<10; i++) {
                        if(!globalData[i]) continue;
                        let cellB = (globalData[i][1] || "").toString(); 
                        if(cellB.includes("통계") && summaryIndex === -1) summaryIndex = i;
                        if(cellB.includes("날짜") && headerIndex === -1) headerIndex = i;
                    }
                    if(summaryIndex === -1) summaryIndex = 1; 
                    if(headerIndex === -1) headerIndex = 2;

                    // 2. 수익금 표시 (J1 셀)
                    if (globalData[0] && globalData[0][9]) {
                        let rawAmount = globalData[0][9]; 
                        let cleanNum = parseFloat(rawAmount.toString().replace(/[^0-9.-]/g, ''));
                        const profitDisplay = document.getElementById('total-profit-display');
                        if (!isNaN(cleanNum)) {
                            profitDisplay.innerText = "₩" + cleanNum.toLocaleString();
                        } else {
                            profitDisplay.innerText = rawAmount; 
                        }
                    }

                    // 3. 드롭다운 메뉴 자동 생성 (가장 중요!)
                    populateMonthFilter(globalData, summaryIndex, headerIndex);

                    // 4. 테이블 그리기 (초기값: ALL)
                    renderFilteredTable();
                },
                error: function(err) {
                    console.error("Error:", err);
                }
            });
        }

        // 존재하는 날짜만 찾아서 드롭다운 만들기
        function populateMonthFilter(data, sumIdx, headIdx) {
            const select = document.getElementById('month-filter');
            // 기존 옵션 초기화 (전체기록만 남김)
            select.innerHTML = '<option value="ALL">전체기록</option>';
            
            const monthSet = new Set();

            for (let i = 0; i < data.length; i++) {
                if (i === sumIdx || i === headIdx) continue;
                const row = data[i];
                if (!row[1]) continue;
                
                // 날짜 컬럼(B열, index 1) 확인 (예: 2025-12-15)
                const dateStr = row[1].toString();
                
                // 정규식으로 YYYY-MM 형태인지 확인
                // 20xx-xx 로 시작하는지 체크
                if (/^20\d{2}-\d{2}/.test(dateStr)) {
                    // 앞 7글자만 잘라서 저장 (2025-12)
                    monthSet.add(dateStr.substring(0, 7));
                }
            }

            // Set을 배열로 변환해서 정렬 (최신순? 과거순? -> 보통 오름차순)
            const sortedMonths = Array.from(monthSet).sort();

            sortedMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.innerText = month;
                select.appendChild(option);
            });
        }

        // 필터링된 테이블 그리기
        function renderFilteredTable() {
            const filterValue = document.getElementById('month-filter').value;
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');

            thead.innerHTML = '';
            tbody.innerHTML = '';

            // 1단 고정 (노란줄)
            const row1 = globalData[summaryIndex];
            let html1 = `<tr>`;
            html1 += `<th colspan="3" class="sticky-top-1" style="text-align:center;">${row1[1] || '수익률 통계'}</th>`; 
            html1 += `<th class="sticky-top-1">${row1[4] || ''}</th>`;
            html1 += `<th class="sticky-top-1">${row1[5] || ''}</th>`;
            html1 += `<th class="sticky-top-1">${row1[6] || ''}</th>`;
            html1 += `<th class="sticky-top-1">${row1[7] || ''}</th>`;
            html1 += `<th class="sticky-top-1">${row1[8] || ''}</th>`;
            html1 += `<th class="sticky-top-1">${row1[9] || ''}</th>`;
            html1 += `</tr>`;
            thead.innerHTML += html1;

            // 2단 고정 (검은줄)
            let html2 = `<tr>`;
            html2 += `<th class="sticky-top-2">날짜</th>`;
            html2 += `<th class="sticky-top-2">종목</th>`;
            html2 += `<th class="sticky-top-2">진입시간</th>`;
            html2 += `<th class="sticky-top-2">포지션</th>`;
            html2 += `<th class="sticky-top-2">손절</th>`;
            html2 += `<th class="sticky-top-2">익절</th>`;
            html2 += `<th class="sticky-top-2">레버리지20X</th>`;
            html2 += `<th class="sticky-top-2">수수료포함</th>`;
            html2 += `<th class="sticky-top-2">페이백 적용시</th>`;
            html2 += `</tr>`;
            thead.innerHTML += html2;

            // 데이터 루프
            for (let i = 0; i < globalData.length; i++) {
                if (i === summaryIndex || i === headerIndex) continue;
                
                const row = globalData[i];
                if (!row[1] && !row[2]) continue;

                const colB = (row[1] || "").toString();

                // [렌더링 로직]
                let showRow = false;

                // 1. 중간 통계 줄인지 확인 (예: "12/28 통계" or "2025.12 통계")
                const isSummaryRow = colB.includes("통계") || colB.includes("비중");
                
                // 2. 일반 데이터 줄인지 확인 (YYYY-MM-DD 형식)
                const isDataRow = /^20\d{2}-\d{2}/.test(colB);

                // [필터링 핵심]
                if (filterValue === "ALL") {
                    showRow = true;
                } else {
                    // 특정 달을 선택했을 때 (예: 2025-12)
                    
                    if (isDataRow) {
                        // 날짜가 선택한 달로 시작하는지 (2025-12-xx)
                        if (colB.startsWith(filterValue)) {
                            showRow = true;
                        }
                    } else if (isSummaryRow) {
                        // 통계줄의 경우: 날짜 문자열에 "12"가 포함되는지 등으로 판단하거나
                        // 시트의 "2025.12 통계" 형식이라면 점(.)을 -로 바꿔서 비교
                        // 2025.12 -> 2025-12
                        let normalizedStr = colB.replace('.', '-');
                        if (normalizedStr.includes(filterValue)) {
                            showRow = true;
                        } else if (colB.includes('/')) {
                             // "12/28 통계" 같은 일별 통계는 해당 월에 포함되면 보여줌
                             // 하지만 이 부분은 복잡할 수 있어, 일단 데이터 행 기준으로 앞뒤 통계를 보여주거나
                             // 지금은 단순하게 '해당 월' 데이터만 정확히 보여주는걸 우선함.
                             // 일별 통계 줄은 해당 일이 속한 달인지를 알기 어려우므로(시트 구조상),
                             // 현재 로직에서는 "데이터 행"이 가장 중요합니다.
                             // 일단 통계 줄은 무조건 보여주거나, 데이터가 있는 곳 근처만 보여주는게 좋은데
                             // 심플하게: ALL이 아니면 일별 통계줄은 숨기거나(복잡하니까), 
                             // 혹은 데이터 행만 보여주는 게 깔끔할 수 있습니다.
                             
                             // 사장님 요청: "2025년12월 한달 이력만 나오고"
                             // -> 날짜가 2025-12로 시작하는 줄 + 2025.12 월별 통계 줄만 표시 시도
                             
                             // 월별 통계줄(노란색)은 보통 "2025.12 통계"라고 적혀있음.
                             if (normalizedStr.includes(filterValue)) showRow = true;
                        }
                    }
                }

                if (!showRow) continue;

                // --- 그리기 ---
                if (isSummaryRow) {
                     let html = `<tr class="sub-summary-row">`;
                     html += `<td colspan="3" style="text-align:left; padding-left:20px;">${colB}</td>`;
                     html += `<td>${row[4] || ''}</td>`;
                     html += `<td class="text-down">${row[5] || ''}</td>`;
                     html += `<td class="text-up">${row[6] || ''}</td>`;
                     html += `<td>${row[7] || ''}</td>`;
                     html += `<td>${row[8] || ''}</td>`;
                     html += `<td>${row[9] || ''}</td>`;
                     html += `</tr>`;
                     tbody.innerHTML += html;
                }
                else if (colB.length > 0 && !colB.includes("날짜")) {
                    const pos = (row[4] || "").toUpperCase().replace('LONG', 'Long').replace('SHORT', 'Short');
                    
                    let lev = row[7] || "";
                    let levColor = lev.includes('-') ? '#e74c3c' : '#2ecc71';
                    
                    let fee = row[8] || "";
                    let feeColor = fee.includes('-') ? '#e74c3c' : '#2ecc71';
                    
                    let payback = row[9] || "";
                    let paybackColor = payback.includes('-') ? '#e74c3c' : '#2ecc71';

                    let html = `<tr class="data-row">`;
                    html += `<td>${row[1] || ''}</td>`; 
                    html += `<td class="text-white">${row[2] || ''}</td>`; 
                    html += `<td class="text-gray">${row[3] || ''}</td>`; 
                    html += `<td class="text-gray">${pos}</td>`; 
                    html += `<td class="text-down">${row[5] || ''}</td>`; 
                    html += `<td class="text-up">${row[6] || ''}</td>`; 
                    html += `<td style="color: ${levColor}; font-weight: bold;">${lev}</td>`; 
                    html += `<td style="color: ${feeColor}; font-weight: bold;">${fee}</td>`; 
                    html += `<td style="color: ${paybackColor}; font-weight: bold; font-size: 1.1em;">${payback}</td>`; 
                    html += `</tr>`;
                    tbody.innerHTML += html;
                }
            }
        }

        loadSheetData();
        setInterval(() => location.reload(), 30 * 60 * 1000);
    </script>
</body>
</html>