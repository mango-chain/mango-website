<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 성과 - Mango Chain</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-color: #111111; --card-color: #1a1a1a; --point-color: #FFC107; --text-color: #ffffff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Pretendard', sans-serif; }
        
        /* 네비게이션바 (z-index 최상위) */
        .navbar { background: rgba(17, 17, 17, 0.95); border-bottom: 1px solid #333; z-index: 1050; height: 56px; }
        .nav-link { color: #ccc !important; margin: 0 10px; }
        .nav-link.active, .nav-link:hover { color: var(--point-color) !important; }
        .btn-main { background-color: var(--point-color); color: #000; font-weight: 700; border-radius: 50px; padding: 8px 25px; }

        .page-header { padding-top: 120px; text-align: center; margin-bottom: 30px; }
        .page-title { color: var(--point-color); font-weight: 800; font-size: 2rem; letter-spacing: -1px; }

        .table-container { 
            background: #111; 
            border: 2px solid var(--point-color); 
            border-radius: 15px; 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.1);
            /* 가로 스크롤 허용 (화면 작을 때 짤림 방지) */
            overflow-x: auto; 
            max-height: 80vh; /* 세로 스크롤 생성 */
            position: relative;
        }

        .custom-table { 
            width: 100%; 
            min-width: 800px; /* 너무 좁아지지 않게 최소 너비 설정 */
            border-collapse: separate; /* sticky 사용 시 collapse보다 안전 */
            border-spacing: 0;
            font-size: 0.85rem; 
            table-layout: fixed; /* [중요] 열 너비 강제 고정 */
        }
        
        .custom-table th, .custom-table td { 
            padding: 12px 5px; 
            text-align: center; 
            border-bottom: 1px solid #333; 
            border-right: 1px solid #222;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* ▼▼▼ [핵심] 2단 틀 고정 스타일 ▼▼▼ */
        
        /* 1단: 노란색 통계 줄 */
        .sticky-top-1 {
            position: sticky;
            top: 0; /* 컨테이너 기준 최상단 */
            background-color: var(--point-color) !important;
            color: #000 !important;
            font-weight: 800;
            z-index: 1020;
            height: 45px;
            border-bottom: 1px solid #000;
        }

        /* 2단: 헤더(날짜/종목) 줄 */
        .sticky-top-2 {
            position: sticky;
            top: 45px; /* 1단 높이만큼 띄움 */
            background-color: #2c2c2c !important;
            color: #fff !important;
            font-weight: bold;
            z-index: 1020;
            height: 45px;
            border-bottom: 2px solid var(--point-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* 데이터 스타일 */
        .data-row { background-color: #1a1a1a; color: #bbb; }
        .data-row:hover { background-color: #2a2a2a; }
        
        /* 중간 통계 줄 (12/27 통계 등) */
        .sub-summary-row { background-color: #333 !important; color: #ffeb3b !important; font-weight: bold; }

        /* 색상 유틸리티 */
        .text-white { color: #ffffff !important; font-weight: bold; }
        .text-gray { color: #888888 !important; font-weight: 500; }
        .text-up { color: #2ecc71 !important; font-weight: bold; }
        .text-down { color: #e74c3c !important; font-weight: bold; }

        #loading { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-lightning-charge-fill text-warning"></i> MANGO CHAIN</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="/">홈</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pricing">상품설명</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/performance">실시간성과</a></li>
                    <li class="nav-item ms-3"><a class="btn btn-main" href="/bot">자동매매봇 입장</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="container page-header">
        <div class="d-inline-block text-center mb-3">
            <img src="{{ url_for('static', filename='favicon.png') }}" alt="Mango" style="width: 50px; margin-bottom: 10px;">
            <div class="page-title">MANGO SIGNAL RECORD</div>
            <div class="mt-2">
                <span class="badge bg-dark border border-warning text-warning">
                    <i class="bi bi-stars"></i> 30분마다 자동 업데이트 중
                </span>
            </div>
        </div>
    </section>

    <section class="container-fluid px-md-5 pb-5"> <div class="table-container">
            <table class="custom-table" id="trade-table">
                <colgroup>
                    <col style="width: 12%"> <col style="width: 8%">  <col style="width: 10%"> <col style="width: 8%">  <col style="width: 10%"> <col style="width: 10%"> <col style="width: 12%"> <col style="width: 12%"> <col style="width: 18%"> </colgroup>
                
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
            
            <div id="loading">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 small">데이터 불러오는 중...</p>
            </div>
        </div>
    </section>

    <footer style="border-top: 1px solid #333; padding: 50px 0; margin-top: 50px; color: #666; text-align: center;">
        <div class="container">
            <p class="small">&copy; 2025 Mango Chain. All rights reserved.</p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const sheetId = '1UpncS47X9zbM0FUNwOvr7jCIOsfkUugdmxgkDy1Ntlw';
        const gid = '262148501';

        function loadSheetData() {
            const timestamp = new Date().getTime(); 
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&t=${timestamp}`;

            const loading = document.getElementById('loading');
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            Papa.parse(csvUrl, {
                download: true,
                header: false,
                complete: function(results) {
                    const data = results.data;
                    thead.innerHTML = ''; 
                    tbody.innerHTML = ''; 
                    loading.style.display = 'none';

                    // 데이터가 너무 적으면 중단
                    if(data.length < 5) return;

                    // 1. [상단 고정] 첫 번째 줄: 노란색 통계 (Row 1)
                    // 구글시트에서 첫번째 줄이 보통 헤더거나 제목일 수 있는데, 
                    // 보내주신 사진의 "수익률 통계" 줄을 찾아서 1단 고정시킵니다.
                    
                    // 시트 구조상 2번째 줄이 노란 통계, 3번째 줄이 헤더인 것으로 추정됩니다.
                    // (CSV는 0부터 시작하므로 index 1과 2를 사용하거나, 내용을 보고 찾습니다)
                    
                    let summaryRowIndex = -1;
                    let headerRowIndex = -1;

                    // "통계" 줄과 "날짜" 줄 찾기
                    for(let i=0; i<10; i++) { // 위에서 10줄만 검색
                        if(!data[i]) continue;
                        let str = JSON.stringify(data[i]);
                        if(str.includes("통계") && summaryRowIndex === -1) summaryRowIndex = i;
                        if(str.includes("날짜") && str.includes("종목") && headerRowIndex === -1) headerRowIndex = i;
                    }

                    // 만약 못 찾으면 기본값 (Row 1, Row 2)
                    if(summaryRowIndex === -1) summaryRowIndex = 1; 
                    if(headerRowIndex === -1) headerRowIndex = 2;

                    // --- 1단 고정: 노란색 통계 ---
                    const row1 = data[summaryRowIndex];
                    let html1 = `<tr>`;
                    // 사진처럼 날짜+종목+진입시간 합쳐서 제목칸으로
                    html1 += `<th colspan="3" class="sticky-top-1" style="text-align:center;">${row1[1] || '수익률 통계'}</th>`; 
                    html1 += `<th class="sticky-top-1">${row1[3] || ''}</th>`; // 포지션 칸 비우거나 내용
                    html1 += `<th class="sticky-top-1">${row1[4] || ''}</th>`; // 손절
                    html1 += `<th class="sticky-top-1">${row1[5] || ''}</th>`; // 익절
                    html1 += `<th class="sticky-top-1">${row1[6] || ''}</th>`; // 레버리지
                    html1 += `<th class="sticky-top-1">${row1[7] || ''}</th>`; // 수수료
                    html1 += `<th class="sticky-top-1">${row1[8] || ''}</th>`; // 페이백
                    html1 += `</tr>`;
                    thead.innerHTML += html1;

                    // --- 2단 고정: 날짜/종목 헤더 ---
                    const row2 = data[headerRowIndex];
                    let html2 = `<tr>`;
                    html2 += `<th class="sticky-top-2">날짜</th>`;
                    html2 += `<th class="sticky-top-2">종목</th>`;
                    html2 += `<th class="sticky-top-2">진입시간</th>`;
                    html2 += `<th class="sticky-top-2">포지션</th>`;
                    html2 += `<th class="sticky-top-2">손절</th>`;
                    html2 += `<th class="sticky-top-2">익절</th>`;
                    html2 += `<th class="sticky-top-2">레버리지</th>`;
                    html2 += `<th class="sticky-top-2">수수료포함</th>`;
                    html2 += `<th class="sticky-top-2">페이백</th>`;
                    html2 += `</tr>`;
                    thead.innerHTML += html2;


                    // --- 본문 데이터 (나머지) ---
                    for (let i = 0; i < data.length; i++) {
                        // 이미 쓴 줄들은 패스
                        if (i === summaryRowIndex || i === headerRowIndex) continue;
                        
                        const row = data[i];
                        if (!row[0] && !row[1]) continue; // 빈 줄 삭제

                        const col0 = (row[0] || "").toString();
                        const col1 = (row[1] || "").toString();

                        // 3. 중간 통계 줄 (예: 12/27 통계)
                        if (col0.includes("통계") || col0.includes("비중")) {
                             let html = `<tr class="sub-summary-row">`;
                             html += `<td colspan="3" style="text-align:left; padding-left:20px;">${row[0]}</td>`;
                             html += `<td>${row[3] || ''}</td>`;
                             html += `<td class="text-down">${row[4] || ''}</td>`;
                             html += `<td class="text-up">${row[5] || ''}</td>`;
                             html += `<td>${row[6] || ''}</td>`;
                             html += `<td>${row[7] || ''}</td>`;
                             html += `<td>${row[8] || ''}</td>`;
                             html += `</tr>`;
                             tbody.innerHTML += html;
                        }
                        // 4. 일반 데이터 줄
                        else if (col1.length > 0 && !col1.includes("종목")) { // 헤더 반복 방지
                            const pos = (row[3] || "").toUpperCase().replace('LONG', 'Long').replace('SHORT', 'Short');
                            let payback = row[8] || "";
                            let profitColor = payback.includes('-') ? '#e74c3c' : '#2ecc71';

                            let html = `<tr class="data-row">`;
                            html += `<td>${row[0] || ''}</td>`;
                            html += `<td class="text-white">${row[1] || ''}</td>`;
                            html += `<td class="text-gray">${row[2] || ''}</td>`;
                            html += `<td class="text-gray">${pos}</td>`;
                            html += `<td class="text-down">${row[4] || ''}</td>`;
                            html += `<td class="text-up">${row[5] || ''}</td>`;
                            html += `<td>${row[6] || ''}</td>`;
                            html += `<td style="color:#aaa;">${row[7] || ''}</td>`;
                            html += `<td style="color: ${profitColor}; font-weight: bold; font-size: 1.1em;">${payback}</td>`;
                            html += `</tr>`;
                            tbody.innerHTML += html;
                        }
                    }
                },
                error: function(err) {
                    console.error("Error:", err);
                    loading.innerHTML = "<p class='text-danger'>데이터 로딩 실패</p>";
                }
            });
        }

        loadSheetData();
        setInterval(() => location.reload(), 30 * 60 * 1000);
    </script>
</body>
</html>