<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì„±ê³¼ - Mango Chain</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-color: #111111; --card-color: #1a1a1a; --point-color: #FFC107; --text-color: #ffffff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Pretendard', sans-serif; }
        
        .navbar { background: rgba(17, 17, 17, 0.95); border-bottom: 1px solid #333; }
        .nav-link { color: #ccc !important; margin: 0 10px; }
        .nav-link.active, .nav-link:hover { color: var(--point-color) !important; }
        .btn-main { background-color: var(--point-color); color: #000; font-weight: 700; border-radius: 50px; padding: 8px 25px; }

        /* ì„±ê³¼ ìš”ì•½ ì¹´ë“œ */
        .stat-card { background: var(--card-color); border: 1px solid #333; border-radius: 15px; padding: 30px; text-align: center; }
        .stat-title { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: white; }
        
        /* í•œêµ­ ì£¼ì‹ ìŠ¤íƒ€ì¼: ë¹¨ê°•(ìˆ˜ìµ), íŒŒë‘(ì†ì‹¤) */
        .text-profit { color: #ff5252 !important; } 
        .text-loss { color: #448aff !important; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-dark { background-color: var(--card-color); --bs-table-bg: var(--card-color); }
        .table-dark th { color: var(--point-color); border-bottom: 1px solid #444; font-weight: 500; }
        .table-dark td { color: #ccc; border-bottom: 1px solid #333; vertical-align: middle; height: 50px; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        #loading { text-align: center; padding: 50px; color: #666; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-lightning-charge-fill text-warning"></i> MANGO CHAIN</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="/">í™ˆ</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pricing">ìƒí’ˆì„¤ëª…</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/performance">ì‹¤ì‹œê°„ì„±ê³¼</a></li>
                    <li class="nav-item ms-3"><a class="btn btn-main" href="/bot">ìë™ë§¤ë§¤ë´‡ ì…ì¥</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="container" style="padding-top: 150px;">
        <h2 class="fw-bold mb-4">ğŸ“ˆ ì‹¤ì‹œê°„ <span style="color:var(--point-color)">íŠ¸ë ˆì´ë”© ì„±ê³¼</span></h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-title">ì´ ëˆ„ì  ìˆ˜ìµë¥ </div>
                    <div class="stat-value" id="total-profit">0%</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-title">ì´ ê±°ë˜ íšŸìˆ˜</div>
                    <div class="stat-value text-white" id="total-trades">0íšŒ</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-title">ìŠ¹ë¥  (Win Rate)</div>
                    <div class="stat-value" style="color:var(--point-color)" id="win-rate">0%</div>
                </div>
            </div>
        </div>
    </section>

    <section class="container py-5 mb-5">
        <h4 class="fw-bold mb-3 text-white">ìµœê·¼ ë§¤ë§¤ ë¡œê·¸ (Live Log)</h4>
        <div class="table-responsive">
            <table class="table table-dark table-hover text-center" id="trade-table">
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>ì½”ì¸</th>
                        <th>í¬ì§€ì…˜</th>
                        <th>ì§„ì…ê°€</th>
                        <th>ì²­ì‚°ê°€</th>
                        <th>ìˆ˜ìµë¥ </th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
            <div id="loading">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2">êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </section>

    <footer style="border-top: 1px solid #333; padding: 50px 0; margin-top: 50px; color: #666; text-align: center;">
        <div class="container">
            <p class="small">&copy; 2025 Mango Chain. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì • ì •ë³´ë¥¼ ë„£ìŠµë‹ˆë‹¤ â–¼â–¼â–¼
        const sheetId = '1UpncS47X9zbM0FUNwOvr7jCIOsfkUugdmxgkDy1Ntlw';
        const gid = '262148501'; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
        function loadSheetData() {
            // [ì¤‘ìš”] URL ë’¤ì— &t=í˜„ì¬ì‹œê°„ ì„ ë¶™ì—¬ì„œ ë¸Œë¼ìš°ì €ê°€ ë§¤ë²ˆ ìƒˆ íŒŒì¼ë¡œ ì¸ì‹í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤ (ìºì‹œ ë°©ì§€)
            const timestamp = new Date().getTime(); 
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&t=${timestamp}`;

            // ë¡œë”© í‘œì‹œ ì¼œê¸° (ì—…ë°ì´íŠ¸ ì¤‘ì„ì„ ì•Œë¦¼)
            const loading = document.getElementById('loading');
            const tbody = document.getElementById('table-body');
            
            // ì²˜ìŒ ë¡œë”©ì´ ì•„ë‹ˆë©´ íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë¡œë”©ë°”ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŒ
            // loading.style.display = 'block'; 

            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    
                    // ê¸°ì¡´ í…Œì´ë¸” ë‚´ìš© ì‹¹ ë¹„ìš°ê¸° (ì¤‘ë³µ ë°©ì§€)
                    tbody.innerHTML = '';
                    
                    // í†µê³„ ê³„ì‚°ìš© ë³€ìˆ˜ ì´ˆê¸°í™”
                    let totalProfit = 0;
                    let winCount = 0;
                    let tradeCount = 0;

                    // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
                    // data.reverse(); 

                    data.forEach(row => {
                        // ë¹ˆ ì¤„ì€ ë¬´ì‹œ
                        if (!row['ì½”ì¸'] && !row['Coin']) return;

                        const cols = Object.values(row);
                        if (cols.length < 6) return;

                        const time = cols[0];
                        const coin = cols[1];
                        const side = cols[2];
                        const entry = cols[3];
                        const exit = cols[4];
                        let roeStr = cols[5];

                        let roe = parseFloat(roeStr.replace('%', ''));
                        if (isNaN(roe)) roe = 0;

                        tradeCount++;
                        totalProfit += roe;
                        if (roe > 0) winCount++;

                        const colorClass = roe >= 0 ? 'text-profit' : 'text-loss';
                        const roeSign = roe >= 0 ? '+' : '';

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${time}</td>
                            <td class="fw-bold">${coin}</td>
                            <td><span class="badge ${side.toUpperCase() === 'LONG' ? 'bg-danger' : 'bg-primary'}">${side}</span></td>
                            <td>${entry}</td>
                            <td>${exit}</td>
                            <td class="${colorClass} fw-bold">${roeSign}${roe}%</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // ë¡œë”© í™”ë©´ ë„ê¸°
                    loading.style.display = 'none';

                    // í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('total-trades').innerText = tradeCount + "íšŒ";
                    
                    const profitElem = document.getElementById('total-profit');
                    profitElem.innerText = (totalProfit > 0 ? '+' : '') + totalProfit.toFixed(2) + "%";
                    profitElem.className = "stat-value " + (totalProfit >= 0 ? "text-profit" : "text-loss");

                    const winRate = tradeCount > 0 ? (winCount / tradeCount * 100).toFixed(1) : 0;
                    document.getElementById('win-rate').innerText = winRate + "%";
                    
                    console.log(`[${new Date().toLocaleTimeString()}] ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
                },
                error: function(err) {
                    console.error("êµ¬ê¸€ ì‹œíŠ¸ ë¡œë”© ì‹¤íŒ¨:", err);
                }
            });
        }

        // 1. í˜ì´ì§€ ì—´ë¦¬ìë§ˆì ì‹¤í–‰
        loadSheetData();

        // 2. 30ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì‹¤í–‰ (30ë¶„ * 60ì´ˆ * 1000ë°€ë¦¬ì´ˆ)
        setInterval(function() {
            // ì „ì²´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë” ê¹”ë”í•©ë‹ˆë‹¤.
            location.reload(); 
        }, 30 * 60 * 1000);

    </script>
</body>
</html>