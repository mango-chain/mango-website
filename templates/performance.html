<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 성과 - Mango Chain</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-color: #111111; --card-color: #1a1a1a; --point-color: #FFC107; --text-color: #ffffff; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Pretendard', sans-serif; }
        
        .navbar { background: rgba(17, 17, 17, 0.95); border-bottom: 1px solid #333; }
        .nav-link { color: #ccc !important; margin: 0 10px; }
        .nav-link.active, .nav-link:hover { color: var(--point-color) !important; }
        .btn-main { background-color: var(--point-color); color: #000; font-weight: 700; border-radius: 50px; padding: 8px 25px; }

        /* 타이틀 섹션 */
        .page-header { padding-top: 150px; text-align: center; margin-bottom: 40px; }
        .page-title { color: var(--point-color); font-weight: 800; font-size: 2rem; letter-spacing: -1px; }
        .page-subtitle { color: #888; font-size: 0.9rem; margin-top: 10px; }

        /* 테이블 디자인 (망고 스타일) */
        .table-container { 
            background: #111; 
            border: 2px solid var(--point-color); 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.1);
        }

        .custom-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .custom-table th, .custom-table td { padding: 12px 5px; text-align: center; border-bottom: 1px solid #333; }
        
        /* 헤더 스타일 */
        .table-header { background-color: #222; color: #aaa; font-weight: bold; font-size: 0.8rem; }
        
        /* 데이터 스타일 */
        .data-row { background-color: #1a1a1a; color: #fff; }
        .data-row:hover { background-color: #2a2a2a; }

        /* 노란색 통계 줄 스타일 */
        .summary-row { background-color: var(--point-color); color: #000 !important; font-weight: 800; border-bottom: 1px solid #000; }
        .summary-row td { color: #000 !important; border-right: 1px solid rgba(0,0,0,0.1); }

        /* 색상 유틸리티 */
        .text-up { color: #2ecc71 !important; font-weight: bold; } /* 수익 (초록) */
        .text-down { color: #e74c3c !important; font-weight: bold; } /* 손실 (빨강) */
        .badge-long { background: #2ecc71; color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;}
        .badge-short { background: #e74c3c; color: #fff; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem;}

        /* 로딩 애니메이션 */
        #loading { text-align: center; padding: 50px; color: #666; }
        
        /* 모바일 대응 */
        @media (max-width: 768px) {
            .custom-table { font-size: 0.7rem; }
            .hide-mobile { display: none; } /* 모바일에서 덜 중요한 컬럼 숨기기 */
            .custom-table th, .custom-table td { padding: 8px 2px; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-lightning-charge-fill text-warning"></i> MANGO CHAIN</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item"><a class="nav-link" href="/">홈</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pricing">상품설명</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/performance">실시간성과</a></li>
                    <li class="nav-item ms-3"><a class="btn btn-main" href="/bot">자동매매봇 입장</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="container page-header">
        <div class="d-inline-block text-center mb-3">
             <img src="{{ url_for('static', filename='favicon.png') }}" alt="Mango" style="width: 50px; margin-bottom: 10px;">
            <div class="page-title">MANGO SIGNAL RECORD</div>
            <div class="page-subtitle">[투명한 공개]가 곧 실력의 증명입니다.</div>
            <div class="mt-3">
                <span class="badge bg-dark border border-warning text-warning">
                    <i class="bi bi-stars"></i> 30분마다 자동 업데이트 중
                </span>
            </div>
        </div>
    </section>

    <section class="container pb-5">
        <div class="table-container">
            <table class="custom-table" id="trade-table">
                <thead>
                    <tr class="table-header">
                        <th style="width:12%">날짜</th>
                        <th style="width:8%">종목</th>
                        <th style="width:10%" class="hide-mobile">진입시간</th>
                        <th style="width:8%">포지션</th>
                        <th style="width:10%">손절</th>
                        <th style="width:10%">익절</th>
                        <th style="width:12%" class="hide-mobile">레버리지20X</th>
                        <th style="width:15%">페이백 적용시</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>

            <div id="loading">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 small">구글 시트 데이터 불러오는 중...</p>
            </div>
        </div>
        
        <p class="text-center mt-4 text-secondary small">
            * 본 데이터는 바이낸스(Binance) 거래소 기준 실시간 매매 내역입니다.<br>
            * 페이백 적용 수익률은 수수료 환급을 포함한 최종 수익률입니다.
        </p>
    </section>

    <footer style="border-top: 1px solid #333; padding: 50px 0; margin-top: 50px; color: #666; text-align: center;">
        <div class="container">
            <p class="small">이메일: support@mango-chain.com | 텔레그램: @Orange2Mango</p>
            <p class="small text-muted">&copy; 2025 Mango Chain. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const sheetId = '1UpncS47X9zbM0FUNwOvr7jCIOsfkUugdmxgkDy1Ntlw';
        const gid = '262148501';

        function loadSheetData() {
            const timestamp = new Date().getTime(); 
            // header: false로 해서 우리가 직접 모든 줄을 검사합니다.
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}&t=${timestamp}`;

            const loading = document.getElementById('loading');
            const tbody = document.getElementById('table-body');
            
            Papa.parse(csvUrl, {
                download: true,
                header: false, // 헤더 없이 0, 1, 2 인덱스로 가져옵니다
                complete: function(results) {
                    const data = results.data;
                    tbody.innerHTML = ''; // 초기화

                    // 데이터 한 줄씩 검사
                    for (let i = 0; i < data.length; i++) {
                        const row = data[i];
                        
                        // 빈 줄은 패스
                        if (!row[0] && !row[1]) continue;

                        // [1] 노란색 통계 줄인지 확인 (예: "12/29 통계")
                        // 특징: 첫번째 칸에 날짜가 있거나 "통계"라는 단어가 포함됨
                        // 시트 구조상 '통계'라는 글자가 있거나, 배경이 노란 줄을 찾습니다.
                        // 여기서는 내용으로 판단합니다.
                        const col0 = row[0] || "";
                        const col1 = row[1] || "";
                        
                        // 통계 줄 판단 로직: "통계"라는 단어가 있거나, 특정 형식이면
                        if (col0.includes("통계") || col0.includes("비중")) {
                             // 통계 줄 그리기
                             let html = `<tr class="summary-row">`;
                             html += `<td colspan="2">${row[0]}</td>`; // 날짜/제목
                             html += `<td class="hide-mobile">${row[2] || ''}</td>`; // 롱/숏 비율 등
                             html += `<td>${row[3] || ''}</td>`; // 포지션 정보
                             html += `<td>${row[4] || ''}</td>`; // 손절합계
                             html += `<td>${row[5] || ''}</td>`; // 익절합계
                             html += `<td class="hide-mobile">${row[6] || ''}</td>`; // 레버리지
                             html += `<td>${row[8] || ''}</td>`; // 페이백 (중요)
                             html += `</tr>`;
                             tbody.innerHTML += html;
                             continue; // 다음 줄로
                        }

                        // [2] 중간 헤더(날짜, 종목, 진입시간...)는 건너뛰기
                        if (col1 === "종목" || col1 === "Symbol") {
                            continue;
                        }

                        // [3] 실제 매매 데이터 줄 (종목란에 BTC, ETH, SOL, XRP 등이 있는 경우)
                        const validCoins = ["BTC", "ETH", "SOL", "XRP", "DOGE", "ADA"];
                        // 코인 이름이 포함되어 있거나, 날짜 형식이 있는 경우
                        if (validCoins.some(coin => col1.includes(coin)) || row[0].includes("2025")) {
                            // 데이터 매핑 (구글시트 열 번호 기준: A=0, B=1, ...)
                            const date = row[0];
                            const symbol = row[1];
                            const time = row[2];
                            const position = row[3]; // Long/Short
                            const stopLoss = row[4];
                            const takeProfit = row[5];
                            const lev20 = row[6];
                            const feeInc = row[7];
                            const payback = row[8]; // 페이백 적용

                            // 포지션 뱃지
                            let posBadge = '';
                            if (position) {
                                if (position.toUpperCase().includes('LONG')) posBadge = '<span class="badge-long">Long</span>';
                                else if (position.toUpperCase().includes('SHORT')) posBadge = '<span class="badge-short">Short</span>';
                                else posBadge = position;
                            }

                            // 수익률 컬러링 (페이백 기준)
                            let profitClass = '';
                            if (payback && payback.includes('-')) profitClass = 'text-down'; // 마이너스면 빨강
                            else if (payback) profitClass = 'text-up'; // 아니면 초록

                            let html = `<tr class="data-row">`;
                            html += `<td>${date}</td>`;
                            html += `<td class="fw-bold">${symbol}</td>`;
                            html += `<td class="hide-mobile text-secondary">${time}</td>`;
                            html += `<td>${posBadge}</td>`;
                            html += `<td class="text-down">${stopLoss || ''}</td>`;
                            html += `<td class="text-up">${takeProfit || ''}</td>`;
                            html += `<td class="hide-mobile">${lev20 || ''}</td>`;
                            html += `<td class="${profitClass}" style="font-size:1.1em;">${payback || ''}</td>`;
                            html += `</tr>`;
                            tbody.innerHTML += html;
                        }
                    }
                    
                    loading.style.display = 'none';
                },
                error: function(err) {
                    console.error("Error:", err);
                }
            });
        }

        loadSheetData();
        setInterval(() => location.reload(), 30 * 60 * 1000);
    </script>
</body>
</html>